<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–ì–≠ ‚Äî –≠–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é: –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <!-- –ï–ì–≠-–ø–∞–ª–∏—Ç—Ä–∞ –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
  <link rel="stylesheet" href="./style_common.css" />

  <!-- –ê–Ω—Ç–∏-–º–∏–≥–∞–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function(){try{
      const saved = localStorage.getItem('pref-theme') || 'light';
      if (saved === 'dark') document.documentElement.classList.add('dark');
    }catch{}})();
  </script>

  <style>
    .wrap{ max-width:1100px; margin:0 auto; padding:40px 20px; text-align:center; }
    .title{ font-size:42px; font-weight:800; margin:0 0 20px; color:var(--primary); }
    .timer{
      font-size:100px; font-weight:800; color:var(--primary);
      text-shadow:0 4px 12px rgba(0,0,0,.25); margin:30px 0;
    }
  </style>
</head>
<body>
  <button id="themeBtn" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì –¢–µ–º–∞</button>

  <div class="wrap">
    <div id="title" class="title">–ó–∞–¥–∞–Ω–∏–µ</div>
    <div id="timer" class="timer" aria-live="polite">3</div>
  </div>

  <script type="module">
    import { toggleThemeInit, navigateOnce } from './common.js';
    toggleThemeInit();

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    const params   = new URLSearchParams(location.search);
    const nextRaw  = Number(params.get('next') || '2');   // –æ–∂–∏–¥–∞–µ–º 2..3
    const next     = Math.max(2, Math.min(3, nextRaw));   // –¥–ª—è –û–ì–≠ –≤—Å–µ–≥–æ 3 –∑–∞–¥–∞–Ω–∏—è
    const vQ       = (params.get('variant') || '').replace(/\D+/g,'');
    const vS       = (sessionStorage.getItem('exam_variant') || '').replace(/\D+/g,'');
    const variant  = vQ || vS || '1';

    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —ç–∫–∑–∞–º–µ–Ω–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç
    try {
      sessionStorage.setItem('exam_type', 'oge');
      sessionStorage.setItem('exam_flow', '1');
      sessionStorage.setItem('exam_variant', variant);
    } catch {}

    // –ï—Å–ª–∏ —Å—é–¥–∞ –ø–æ–ø–∞–ª–∏ –≤–Ω–µ —Ä–µ–∂–∏–º–∞ ¬´—ç–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é¬ª ‚Äî –≤–µ—Ä–Ω—ë–º –∫ –≤—ã–±–æ—Ä—É
    if (sessionStorage.getItem('exam_flow') !== '1') {
      navigateOnce('./exams.html');
    }

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    document.getElementById('title').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${next}`;
    try { document.title = `–û–ì–≠ ‚Äî –≠–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é: –ó–∞–¥–∞–Ω–∏–µ ${next}`; } catch {}

    // –ö—É–¥–∞ –∏–¥—Ç–∏ –ø–æ—Å–ª–µ –æ—Ç—Å—á—ë—Ç–∞ (–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º ?exam=1&variant=)
    function nextPrepareUrl(){
      if (next > 3) {
        return `./exams_result.html?exam=1&variant=${encodeURIComponent(variant)}`
          .replace(/\/{2,}/g,'/').replace(':/','://');
      }
      return `./task${next}/variants/variant${variant}/oge${next}_var${variant}_1_prepare.html?exam=1&variant=${encodeURIComponent(variant)}`
        .replace(/\/{2,}/g,'/').replace(':/','://');
    }

    // –û—Ç—Å—á—ë—Ç 3-2-1
    const timerEl = document.getElementById('timer');
    let n = 3;
    timerEl.textContent = n;
    const id = setInterval(()=>{
      timerEl.textContent = n;
      n--;
      if (n < 0){
        clearInterval(id);
        navigateOnce(nextPrepareUrl());
      }
    },1000);

    // –û—á–∏—Å—Ç–∫–∏ –∏ —Å–Ω—è—Ç–∏–µ ¬´–∑–∞–º–∫–∞¬ª
    window.addEventListener('beforeunload', ()=>{ try{ clearInterval(id); }catch{} });
    window.addEventListener('pageshow', ()=>{ navigateOnce.lock = false; });
  </script>
</body>
</html>
