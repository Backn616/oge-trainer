<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–≠–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style_common.css" />

  <script>
    (function(){ try{
      const saved = localStorage.getItem('pref-theme') || 'light';
      if (saved === 'dark') document.documentElement.classList.add('dark');
    }catch{}})();
  </script>

  <style>
    .wrap{ max-width:1100px; margin:0 auto; padding:40px 20px; text-align:center; }
    .title{ font-size:42px; font-weight:800; margin:0 0 20px; color:var(--primary); }
    .timer{
      font-size:100px; font-weight:800; color:var(--primary);
      text-shadow:0 4px 12px rgba(0,0,0,.25); margin:30px 0;
    }
  </style>
</head>
<body>
  <button id="themeBtn" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì –¢–µ–º–∞</button>

  <div class="wrap">
    <div id="title" class="title">Task</div>
    <div id="timer" class="timer" aria-live="polite">3</div>
  </div>

  <script type="module">
    import { toggleThemeInit, navigateOnce } from './common.js';
    toggleThemeInit();

    const params   = new URLSearchParams(location.search);
    const nextRaw  = Number(params.get('next') || '2');          // –æ–∂–∏–¥–∞–µ–º 2..4
    const next     = Math.max(2, Math.min(4, nextRaw));          // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
    const vQ       = (params.get('variant') || '').replace(/\D+/g,'');
    const vS       = (sessionStorage.getItem('exam_variant') || '').replace(/\D+/g,'');
    const variant  = vQ || vS || '1';

    // üîí –í—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ñ–ª–∞–≥–∏ —ç–∫–∑–∞–º–µ–Ω–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî —ç—Ç–æ "—à–∞—Ä–Ω–∏—Ä" –≤—Å–µ–≥–æ —Ñ–ª–æ—É
    try {
      sessionStorage.setItem('exam_flow', '1');
      sessionStorage.setItem('exam_variant', variant);
    } catch {}

    const examFlowOn = sessionStorage.getItem('exam_flow') === '1';
    if (!examFlowOn) {
      // –ï—Å–ª–∏ –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º —Å—é–¥–∞ –ø–æ–ø–∞–ª–∏ –Ω–µ –∏–∑ "—ç–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é" ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –∫ –≤—ã–±–æ—Ä—É
      navigateOnce('./exams.html');
    }

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    document.getElementById('title').textContent = `Task ${next}`;
    try { document.title = `–≠–∫–∑–∞–º–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî Task ${next}`; } catch {}

    // –ö—É–¥–∞ –∏–¥—Ç–∏ –ø–æ—Å–ª–µ –æ—Ç—Å—á—ë—Ç–∞ (–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º ?exam=1&variant=)
    function nextPrepareUrl(){
      if (next > 4) {
        return `./exams_result.html?exam=1&variant=${encodeURIComponent(variant)}`;
      }
      return `./task${next}/variants/variant${variant}/ege${next}_var${variant}_1_prepare.html?exam=1&variant=${encodeURIComponent(variant)}`
        .replace(/\/{2,}/g,'/').replace(':/','://');
    }

    // –û—Ç—Å—á—ë—Ç 3-2-1
    const timerEl = document.getElementById('timer');
    let n = 3;
    timerEl.textContent = n;
    const id = setInterval(()=>{
      timerEl.textContent = n;
      n--;
      if (n < 0){
        clearInterval(id);
        navigateOnce(nextPrepareUrl());
      }
    },1000);

    // –°–±—Ä–æ—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –Ω–∞ –≤—Å—è–∫–∏–π
    window.addEventListener('beforeunload', ()=>{ try{ clearInterval(id); }catch{} });
    window.addEventListener('pageshow', ()=>{ navigateOnce.lock = false; });
  </script>
</body>
</html>
