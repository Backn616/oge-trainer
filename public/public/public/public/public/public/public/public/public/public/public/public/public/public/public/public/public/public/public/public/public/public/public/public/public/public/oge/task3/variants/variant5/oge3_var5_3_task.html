<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>OGE Task 3 ‚Äî Speaking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
  <link rel="stylesheet" href="../../../style_common.css" />

  <!-- –ê–Ω—Ç–∏-–º–∏–≥–∞–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('pref-theme') || 'light';
        if (saved === 'dark') document.documentElement.classList.add('dark');
      }catch(_){}
    })();
  </script>

  <style>
    /* –¢–∞–π–º–µ—Ä-—Ü–∏—Ñ—Ä—ã 3-2-1-0 */
    .timer{
      font-size:70px; margin:30px 0; font-weight:700; color:var(--primary);
      letter-spacing:4px; text-shadow:0 4px 12px rgba(0,0,0,.25);
      transition:transform .25s ease; will-change:transform; text-align:center;
    }
    @media (prefers-reduced-motion: reduce) { .timer{ transition:none; } }

    /* –ü–ª–∞–Ω –º–æ–Ω–æ–ª–æ–≥–∞ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ä–∞–º–∫–∞ */
    .reading-box{
      background:var(--card);
      border:1px solid #ccc;
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:24px 28px;
      text-align:left;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      font-size:22px;
      line-height:1.7;
      max-width:1200px;
      margin:0 auto 24px;
      display:none; /* –ø–æ–∫–∞–∂–µ–º –ø–æ—Å–ª–µ –æ—Ç—Å—á—ë—Ç–∞ */
    }
    .reading-box ul{ margin:12px 0 0 22px; }
    .reading-box li{ margin:6px 0; }
    @media (max-width:900px){
      .reading-box{ font-size:18px; padding:18px 16px; max-width:100%; }
    }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
    .btn{
      display:inline-block; padding:16px 32px; margin:12px;
      font-size:20px; font-weight:600; color:#fff; text-decoration:none; cursor:pointer;
      border:none; border-radius:12px;
      background:linear-gradient(135deg, var(--primary), var(--primary-600));
      box-shadow:0 10px 22px rgba(43,108,255,.3);
      transition: transform .06s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
  </style>
</head>
<body>
  <!-- –¢—É–º–±–ª–µ—Ä —Ç–µ–º—ã -->
  <button id="themeBtn" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì –¢–µ–º–∞</button>

  <div class="content-wrapper">
    <!-- –£–ë–†–ê–ù–û: instructionBox -->

    <!-- –û—Ç—Å—á—ë—Ç 3-2-1-0 -->
    <div id="timer" class="timer" aria-live="polite">3</div>

    <!-- –ü–ª–∞–Ω –º–æ–Ω–æ–ª–æ–≥–∞ (–±–µ–∑ Topic:) -->
    <div class="reading-box" id="textBox" aria-label="–ü–ª–∞–Ω –º–æ–Ω–æ–ª–æ–≥–∞">
      <p>Task 3. You are going to give a talk about holidays. You will have to start in 1.5 minutes and speak for not more than 2 minutes (10‚Äì12 sentences). Remember to say:</p>
      <ul>
        <li>what your favourite holiday is, and why;</li>
        <li>how your family usually celebrates it;</li>
        <li>what special traditions people in your country follow on this holiday;</li>
        <li>what your attitude to celebrating holidays is.</li>
      </ul>
      <p>You have to talk continuously.</p>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
    <div style="text-align:center; margin-bottom:30px;">
      <button class="btn" id="endBtn" type="button" aria-label="–ó–∞–∫–æ–Ω—á–∏—Ç—å –∑–∞–ø–∏—Å—å" style="display:none">‚úÖ –ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ü—Ä–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞–¥ —Ñ–∏–∫—Å-–±–∞—Ä–æ–º -->
  <div style="height: calc(var(--footer-h) + 24px);"></div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (2:00) -->
  <div id="progressContainerFixed" role="timer" aria-live="polite" aria-atomic="true"
       aria-label="–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞" style="display:none">
    <div id="progressBarFixed" class="rAF">
      <span id="progressTime" class="progress-time">02:00</span>
    </div>
  </div>

  <script type="module">
    import { toggleThemeInit, navigateOnce, fmtTime } from '../../../common.js';

    toggleThemeInit();

    const timerEl      = document.getElementById('timer');
    const textBox      = document.getElementById('textBox');
    const endBtn       = document.getElementById('endBtn');
    const progressWrap = document.getElementById('progressContainerFixed');
    const progressBar  = document.getElementById('progressBarFixed');
    const progressTime = document.getElementById('progressTime');

    // ==== –ö—É–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ ====
    function getVariantFromUrlOrState(){
      const q = new URLSearchParams(location.search);
      const vQ = (q.get('variant') || '').replace(/\D+/g,'');
      const vS = (sessionStorage.getItem('exam_variant') || '').replace(/\D+/g,'');
      return vQ || vS || '';
    }
    function inExamFlow(){
      const q = new URLSearchParams(location.search);
      return q.get('exam') === '1' || sessionStorage.getItem('exam_flow') === '1';
    }
    function examsResultUrl(){
      const root = location.pathname.replace(/\/task3\/.*/i, '/');
      const v = getVariantFromUrlOrState();
      return `${root}exams_result.html${v ? `?variant=${encodeURIComponent(v)}` : ''}`;
    }
    function standaloneResultUrl(){
      return /_3_task\.html$/i.test(location.pathname)
        ? location.pathname.replace(/_3_task\.html$/i, '_4_result.html')
        : location.pathname.replace(/\.html$/i, '_4_result.html');
    }
    const RESULT_URL = inExamFlow() ? examsResultUrl() : standaloneResultUrl();
    try{
      if (new URLSearchParams(location.search).get('exam') === '1') {
        sessionStorage.setItem('exam_flow','1');
        const v = getVariantFromUrlOrState(); if (v) sessionStorage.setItem('exam_variant', v);
      }
    }catch{}

    /* === –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∑–∞–ø–∏—Å—å === */
    let mediaRecorder = null, audioChunks = [], streamRef = null;
    let chosenMime = '', hasStopped = false;

    function pickMimeType(){
      const candidates = [
        'audio/webm;codecs=opus','audio/webm','audio/mp4',
        'audio/ogg;codecs=opus','audio/ogg'
      ];
      for (const t of candidates){ if (window.MediaRecorder?.isTypeSupported?.(t)) return t; }
      return '';
    }

    async function initMic(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        streamRef = stream;
        chosenMime = pickMimeType();
        mediaRecorder = chosenMime ? new MediaRecorder(stream, { mimeType: chosenMime }) : new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e)=>{ if (e.data?.size) audioChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          if (hasStopped) return;
          hasStopped = true;
          try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
          const blobType = chosenMime || mediaRecorder.mimeType || 'audio/webm';
          const audioBlob = new Blob(audioChunks, { type: blobType });
          const reader = new FileReader();
          reader.onloadend = () => {
            try{
              sessionStorage.setItem('oge3_audio_base64', reader.result);
              sessionStorage.setItem('oge3_audio_mime', blobType);
              const meta = JSON.parse(sessionStorage.getItem('oge3_meta') || '{}');
              meta.recordedAt = Date.now();
              sessionStorage.setItem('oge3_meta', JSON.stringify(meta));
            }catch{}
            navigateOnce(RESULT_URL);
          };
          reader.readAsDataURL(audioBlob);
        };

        startCountdown();
      }catch(err){
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (err?.message || err));
        startCountdown();
      }
    }

    /* === –û—Ç—Å—á—ë—Ç 3-2-1-0 === */
    let countdown = 3;
    let cdInterval = 0;
    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function startCountdown(){
      timerEl.style.display = 'block';
      timerEl.textContent = countdown;
      cdInterval = setInterval(()=>{
        timerEl.style.color = (countdown > 1) ? '#2b6cff' : '#b30000';
        timerEl.textContent = countdown;
        if (!reduceMotion){
          timerEl.style.transform = 'scale(1.2)';
          setTimeout(()=>{ timerEl.style.transform = 'scale(1)'; }, 200);
        }
        countdown--;
        if (countdown < 0){
          clearInterval(cdInterval);
          startTask();
        }
      },1000);
    }

    /* === –¢–∞–π–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ 2:00 === */
    const TOTAL_MS = 120_000;
    let endTs = 0, rafId = 0, lastAnnounce = 0;

    function startTask(){
      // instructionBox —É–¥–∞–ª—ë–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
      if (textBox) textBox.style.display = 'block';
      endBtn.style.display       = 'inline-block';
      progressWrap.style.display = 'block';
      timerEl.style.display      = 'none';

      audioChunks = [];
      try{
        const meta = JSON.parse(sessionStorage.getItem('oge3_meta') || '{}');
        meta.startedAt = Date.now();
        sessionStorage.setItem('oge3_meta', JSON.stringify(meta));
      }catch{}

      try{ if (mediaRecorder && mediaRecorder.state !== 'recording') mediaRecorder.start(); }catch{}

      progressBar.classList.add('rAF');
      endTs = performance.now() + TOTAL_MS;
      progressTime.textContent = fmtTime(TOTAL_MS);
      progressBar.style.width  = '100%';

      tick();
      endBtn.onclick = ()=> safeStopOrFinish();
    }

    function tick(){
      const left = Math.max(0, endTs - performance.now());
      progressBar.style.width = `${(left / TOTAL_MS) * 100}%`;
      if (!lastAnnounce || performance.now() - lastAnnounce > 250){
        progressTime.textContent = fmtTime(left);
        lastAnnounce = performance.now();
      }
      if (left <= 0){ safeStopOrFinish(); }
      else { rafId = requestAnimationFrame(tick); }
    }

    function safeStopOrFinish(){
      try{ cancelAnimationFrame(rafId); }catch{}
      if (hasStopped){ navigateOnce(RESULT_URL); return; }
      try{
        if (mediaRecorder?.state === 'recording'){ mediaRecorder.stop(); }
        else {
          try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
          navigateOnce(RESULT_URL);
        }
      }catch{
        try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
        navigateOnce(RESULT_URL);
      }
    }

    window.addEventListener('beforeunload', ()=>{
      try{ cancelAnimationFrame(rafId); }catch{}
      try{ if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); }catch{}
      try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
    });

    /* === BFCache: –≤–æ–∑–≤—Ä–∞—Ç ‚Üí —Ä–µ—Å—Ç–∞—Ä—Ç === */
    function isBackForwardNav(){
      try{
        const nav = performance.getEntriesByType('navigation')[0];
        return nav && nav.type === 'back_forward';
      }catch{ return false; }
    }
    function resetAndRestart(){
      try { cancelAnimationFrame(rafId); } catch {}
      try { clearInterval(cdInterval); } catch {}
      try { if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); } catch {}
      try { streamRef?.getTracks()?.forEach(t=>t.stop()); } catch {}

      timerEl.style.display   = 'block';
      timerEl.textContent     = '3';
      if (textBox) textBox.style.display = 'none';
      endBtn.style.display    = 'none';
      progressWrap.style.display = 'none';
      progressBar.style.width = '100%';
      progressTime.textContent= fmtTime(TOTAL_MS);

      audioChunks = [];
      hasStopped  = false;
      countdown   = 3;

      initMic();
    }
    window.addEventListener('pageshow', (e)=>{
      try { navigateOnce.lock = false; } catch {}
      if (e.persisted || isBackForwardNav()) resetAndRestart();
    });

    window.onload = initMic;
  </script>
</body>
</html>
