<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>OGE Task 3 — Preparation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Шрифт Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Общие стили -->
  <link rel="stylesheet" href="../../../style_common.css" />

  <!-- Анти-мигание темы -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('pref-theme') || 'light';
        if (saved === 'dark') document.documentElement.classList.add('dark');
      }catch(_){}
    })();
  </script>

  <style>
    .reading-box{
      background:var(--card);
      border:1px solid #ccc;
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:24px 28px;
      text-align:left;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      font-size:25px;
      line-height:1.7;
      max-width:1200px;
      margin:0 auto 24px;
    }
    .reading-box ul{ margin: 12px 0 0 22px; }
    .reading-box li{ margin: 6px 0; }
    @media (max-width:900px){
      .reading-box{ font-size:18px; padding:18px 16px; max-width:100%; }
    }
  </style>
</head>
<body>
  <button id="themeBtn" class="theme-toggle" aria-label="Переключить тему">🌓 Тема</button>

  <div class="content-wrapper">
    <div class="task-container" role="region" aria-labelledby="taskTitle">
      <p id="taskTitle" style="margin-top:0;">
        <strong>Task 3.</strong> You are going to give a talk. 
        You have <strong>1.5 minutes</strong> to prepare, then you will have to speak for not more than <strong>2 minutes</strong> (10–12 sentences).
      </p>
    </div>

    <!-- Рамка с планом монолога -->
    <div class="reading-box" id="readingBox" aria-label="План монолога">
      <p>Task 3. You are going to give a talk about environmental problems. You will have to start in 1.5 minutes and speak for not more than 2 minutes (10–12 sentences). Remember to say:</p>
      <ul>
        <li>what environmental problems exist in your region;</li>
        <li>why these problems are serious;</li>
        <li>what teenagers can do to help;</li>
        <li>what your attitude to environmental protection is.</li>
      </ul>
      <p>You have to talk continuously.</p>
    </div>

    <div style="text-align:center; margin:22px 0 30px;">
      <button id="goBtn" class="button" type="button" aria-label="Перейти к выполнению">Перейти к выполнению</button>
    </div>
  </div>

  <div style="height: calc(var(--footer-h) + 24px);"></div>

  <!-- Фиксированный прогресс-бар подготовки -->
  <div id="progressContainerFixed" role="timer" aria-live="polite" aria-atomic="true" aria-label="Оставшееся время подготовки">
    <div id="progressBarFixed" class="rAF">
      <span id="progressTime" class="progress-time">01:30</span>
    </div>
  </div>

  <script type="module">
    import { toggleThemeInit, navigateOnce, startPrepareTimer, fmtTime } from "../../../common.js";

    toggleThemeInit();

    // Переход на страницу записи ответа (mic)
    const NEXT_URL = location.pathname.replace(/_1_prepare\.html$/i, '_2_mic.html');
    document.getElementById('goBtn')?.addEventListener('click', () => navigateOnce(NEXT_URL));

    // Флаги подготовки для Task 3
    try{
      sessionStorage.setItem('oge3_prepared', '1');
      sessionStorage.setItem('oge3_meta', JSON.stringify({
        preparedAt: Date.now(),
        prepareDurationSec: 90
      }));
    }catch{}

    // 90 секунд — время подготовки
    const TOTAL_MS = 90_000;
    const barEl  = document.getElementById('progressBarFixed');
    const timeEl = document.getElementById('progressTime');
    let stopTimer = null;

    function startTimerFresh(){
      timeEl.textContent = fmtTime(TOTAL_MS);
      barEl.style.width  = '100%';
      try { stopTimer?.(); } catch {}
      stopTimer = startPrepareTimer({
        barEl,
        timeEl,
        totalMs: TOTAL_MS,
        nextUrl: NEXT_URL,
        key: 'oge3_prepare_end',
        persist: false,
        textEveryMs: 250,
        useRAF: true
      });
    }
    startTimerFresh();

    // Повторный заход из bfcache
    window.addEventListener('pageshow', (e)=>{
      try { navigateOnce.lock = false; } catch {}
      if (e.persisted) startTimerFresh();
    });
  </script>
</body>
</html>
