<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task 4 ‚Äî Variant 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <!-- –ê–Ω—Ç–∏-–º–∏–≥–∞–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('pref-theme') || 'light';
        if(saved === 'dark') document.documentElement.classList.add('dark');
      }catch(_){}
    })();
  </script>

  <style>
    :root {
      --bg: #f7f9ff;
      --card: #ffffff;
      --text: #0b1020;
      --muted: #5a6475;
      --primary: #2b6cff;
      --primary-600: #1f58d9;
      --ring: #bfd3ff;
      --success: #25c26e;
      --danger: #b30000;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
    }
    .dark {
      --bg: #0b1020;
      --card: rgba(255,255,255,0.08);
      --text: #eaf0ff;
      --muted: #a0aabd;
      --primary: #6aa3ff;
      --primary-600: #4b8dff;
      --ring: #3b4b66;
      --success: #25c26e;
      --danger: #ff6b6b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin:0;
      padding: 40px 30px 80px;
      color: var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #29417a40, transparent),
                  radial-gradient(900px 500px at -10% 10%, #344b9340, transparent),
                  var(--bg);
      text-align: center;
    }
    .theme-toggle {
      position: fixed; top:16px; right:16px; z-index:10000;
      border:1px solid #ffffff22; background:transparent; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; backdrop-filter: blur(6px);
      transition: transform .08s ease, filter .2s ease;
    }
    .theme-toggle:hover { transform: translateY(-1px); filter: brightness(1.03); }
    .wrap { max-width:1500px; margin:0 auto; }
    .task-container {
      background: var(--card);
      border-left: 5px solid var(--primary);
      padding: 20px 30px 10px 30px;
      margin: 0 auto 20px;
      font-size: 20px;
      line-height: 1.7;
      text-align: left;
      box-shadow: var(--shadow);
      border-radius: 12px;
      display: none;
    }
    .instruction { font-weight:700; margin-top:10px; }
    .timer {
      font-size: 72px;
      margin: 30px 0;
      font-weight: 700;
    }
    .images {
      display: none;
      justify-content: center;
      align-items: flex-start;
      gap: 30px;
      margin-bottom: 20px;
    }
    .images img {
      max-width:100%;
      height:auto;
      width:48%;
      border-radius:12px;
      box-shadow: var(--shadow);
    }
    .end-button {
      display:none;
      margin: 20px auto 0;
      padding: 16px 32px;
      font-size: 20px;
      font-weight:600;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(43,108,255,.3);
      transition: transform .06s ease, box-shadow .2s ease;
    }
    .end-button:hover { transform: scale(1.05); }
    #progressContainerFixed {
      position: fixed; bottom:0; left:0; width:100%; height:32px;
      background:#eee; z-index:9999; display:none;
    }
    .dark #progressContainerFixed { background: #222; }
    #progressBarFixed {
      height:100%; width:0%;
      background: linear-gradient(to right, #0066ff, #00cfff);
      position:relative; transition: width .5s linear;
    }
    .progress-time {
      position:absolute; right:14px; top:50%; transform:translateY(-50%);
      color:#fff; font-weight:700; font-size:20px; user-select:none;
    }
    @media (max-width: 800px){
      .images{ flex-direction: column; align-items: center; }
      .images img{ width:100%; }
    }
  </style>
</head>
<body>
  <button id="themeBtn" class="theme-toggle">üåì –¢–µ–º–∞</button>

  <div class="wrap">
    <div class="task-container" id="taskContainer">
      <b>4 Task. Imagine that you and your friend are doing a school project ‚ÄúStreet art vs traditional art‚Äù.</b>
      You have found some photos to illustrate it but for technical reasons you cannot send them now. Leave a voice message to your friend explaining your choice of the photos and sharing some ideas about the project. In 3 minutes be ready to:
      <ul>
        <li>explain the choice of the illustrations for the project by briefly describing them and noting the differences;</li>
        <li>mention the advantages (1‚Äì2) of the two types of art;</li>
        <li>mention the disadvantages (1‚Äì2) of the two types of art;</li>
        <li>express your opinion on the subject of the project ‚Äì which type of art you prefer and why.</li>
      </ul>
      <div class="instruction">
        You will speak for not more than 3 minutes (12‚Äì15 sentences). You have to talk continuously.
      </div>
    </div>

    <div class="timer" id="timer">3</div>

    <div class="images" id="imageContainer">
      <img src="1.jpg" alt="City holidays">
      <img src="2.jpg" alt="Countryside holidays">
    </div>

    <button class="end-button" id="endBtn" onclick="endManually()">‚úÖ –ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
  </div>

  <div id="progressContainerFixed">
    <div id="progressBarFixed">
      <span id="progressTime" class="progress-time">03:00</span>
    </div>
  </div>

  <script>
    // –¢–µ–º–∞
    (function(){
      const btn = document.getElementById('themeBtn');
      const key = 'pref-theme';
      const root = document.documentElement;
      function apply(mode){
        root.classList.toggle('dark', mode === 'dark');
        localStorage.setItem(key, mode);
      }
      apply(localStorage.getItem(key) || 'light');
      btn.addEventListener('click', () => {
        const curr = localStorage.getItem(key) || 'light';
        apply(curr === 'dark' ? 'light' : 'dark');
      });
    })();

    const timerEl = document.getElementById("timer");
    const progressBarFixed = document.getElementById("progressBarFixed");
    const progressTime = document.getElementById("progressTime");
    const progressContainerFixed = document.getElementById("progressContainerFixed");
    const imageContainer = document.getElementById("imageContainer");
    const endBtn = document.getElementById("endBtn");
    const taskContainer = document.getElementById("taskContainer");

    // ‚úÖ –†–µ—à–µ–Ω–∏–µ ¬´—á–µ—Ä–µ–∑ n¬ª: ege4_varN_3_task.html ‚Üí ege4_varN_4_result.html
    const RESULT_URL = location.pathname.replace(/_3_task\.html$/i, '_4_result.html');

    let countdown = 3;
    let totalTime = 180;       // —Å–µ–∫
    let startTime;
    let interval;
    let mediaRecorder = null;
    let audioChunks = [];
    let hasStopped = false;
    let streamRef = null;
    let chosenMime = "";
    let navigating = false;
    let taskStarted = false;   // ¬´—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏¬ª –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–¥–∞–Ω–∏—è

    function pickMimeType(){
      const candidates = [
        "audio/webm;codecs=opus",
        "audio/webm",
        "audio/mp4",            // Safari
        "audio/ogg;codecs=opus",
        "audio/ogg"
      ];
      for (const t of candidates){
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
          return t;
        }
      }
      return "";
    }

    async function initMic() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        streamRef = stream;

        chosenMime = pickMimeType();
        try {
          mediaRecorder = chosenMime
            ? new MediaRecorder(stream, { mimeType: chosenMime })
            : new MediaRecorder(stream);
        } catch (e) {
          mediaRecorder = new MediaRecorder(stream);
          chosenMime = mediaRecorder.mimeType || "";
        }

        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) audioChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          if (hasStopped) return;
          hasStopped = true;

          try { streamRef?.getTracks()?.forEach(t => t.stop()); } catch(_) {}

          const blobType = chosenMime || (mediaRecorder && mediaRecorder.mimeType) || "audio/webm";
          const audioBlob = new Blob(audioChunks, { type: blobType });
          const reader = new FileReader();
          reader.onloadend = () => {
            try {
              sessionStorage.setItem("ege4_audio_base64", reader.result);
              sessionStorage.setItem("ege4_audio_mime", blobType);
            } catch (_) {}
            gotoResult();
          };
          reader.readAsDataURL(audioBlob);
        };

        startCountdown();
      } catch (err) {
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
        // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –∑–∞–ø–∏—Å–∏
        mediaRecorder = null;
        startCountdown();
      }
    }

    function startCountdown() {
      const cdInterval = setInterval(() => {
        timerEl.style.color = (countdown > 1) ? "#2b6cff" : "#b30000";
        timerEl.textContent = countdown;
        countdown--;
        if (countdown < 0) {
          clearInterval(cdInterval);
          startTask();
        }
      }, 1000);
    }

    function startTask() {
      taskStarted = true; // —Ç–µ–ø–µ—Ä—å ¬´—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏¬ª –º–æ–∂–Ω–æ —Å–ª—É—à–∞—Ç—å
      timerEl.style.display = "none";
      progressContainerFixed.style.display = "block";
      imageContainer.style.display = "flex";
      taskContainer.style.display = "block";
      endBtn.style.display = "inline-block";

      progressTime.textContent = formatTime(totalTime);
      startTime = Date.now();
      audioChunks = [];

      if (mediaRecorder && mediaRecorder.state !== "recording") {
        try { mediaRecorder.start(); } catch(_) {}
      }

      interval = setInterval(() => {
        const timeElapsed = Math.floor((Date.now() - startTime) / 1000);
        const timeLeft = totalTime - timeElapsed;
        progressTime.textContent = formatTime(timeLeft);
        progressBarFixed.style.width = `${(timeLeft / totalTime) * 100}%`;

        if (timeLeft <= 0) {
          clearInterval(interval);
          safeStopOrFinish();
        }
      }, 500);
    }

    function formatTime(seconds) {
      const min = String(Math.floor(seconds / 60)).padStart(2, '0');
      const sec = String(Math.max(0, seconds % 60)).padStart(2, '0');
      return `${min}:${sec}`;
    }

    function gotoResult(){
      if (!navigating) navigating = true;
      if (location.href.endsWith(RESULT_URL)) return;
      location.href = RESULT_URL;
    }

    function safeStopOrFinish(){
      if (hasStopped) { gotoResult(); return; }
      if (mediaRecorder && mediaRecorder.state === "recording") {
        try { mediaRecorder.stop(); } catch(_) { gotoResult(); }
      } else {
        try { streamRef?.getTracks()?.forEach(t => t.stop()); } catch(_) {}
        gotoResult();
      }
    }

    function endManually() {
      clearInterval(interval);
      safeStopOrFinish();
    }

    // –°—Ç—Ä–∞—Ö–æ–≤–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–¥–∞–Ω–∏—è
    document.addEventListener("visibilitychange", () => {
      if (!taskStarted) return;
      if (document.hidden) {
        try { clearInterval(interval); } catch(_) {}
        safeStopOrFinish();
      }
    });

    window.addEventListener("pagehide", () => {
      if (!taskStarted) return;
      try { clearInterval(interval); } catch(_) {}
      safeStopOrFinish();
    });

    window.addEventListener("freeze", () => {
      if (!taskStarted) return;
      try { clearInterval(interval); } catch(_) {}
      safeStopOrFinish();
    });

    window.addEventListener("beforeunload", () => {
      try { clearInterval(interval); } catch(_) {}
      try { if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop(); } catch(_) {}
      try { streamRef?.getTracks()?.forEach(t => t.stop()); } catch(_) {}
    });

    window.onload = initMic;
  </script>
</body>
</html>
