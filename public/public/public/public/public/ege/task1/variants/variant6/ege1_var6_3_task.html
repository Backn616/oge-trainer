<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Task 1 ‚Äî Reading</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
  <link rel="stylesheet" href="../../../style_common.css" />

  <!-- –ê–Ω—Ç–∏-–º–∏–≥–∞–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('pref-theme') || 'light';
        if (saved === 'dark') document.documentElement.classList.add('dark');
      }catch(_){}
    })();
  </script>

  <style>
    /* –¢–∞–π–º–µ—Ä-—Ü–∏—Ñ—Ä—ã 3-2-1 */
    .timer{
      font-size:70px; margin:30px 0; font-weight:700; color:var(--primary);
      letter-spacing:4px; text-shadow:0 4px 12px rgba(0,0,0,.25);
      transition:transform .25s ease; will-change:transform; text-align:center;
    }
    @media (prefers-reduced-motion: reduce) { .timer{ transition:none; } }

    /* –¢–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî –∫–∞–∫ –≤ prepare (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ä–∞–º–∫–∞) */
    .reading-box{
      background:var(--card);
      border:1px solid #ccc;
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:24px 28px;                 /* –±—ã–ª–æ 40px */
      text-align:left;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      font-size:25px;                     /* –±—ã–ª–æ 32px */
      line-height:1.7;
      max-width:1200px;                   /* –±—ã–ª–æ 2500px */
      margin:0 auto 24px;
      white-space:pre-line;               /* –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∫–∞–∫ –∞–±–∑–∞—Ü—ã */
    }
    @media (max-width:900px){
      .reading-box{ font-size:18px; padding:18px 16px; max-width:100%; }
    }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
    .btn{
      display:inline-block; padding:16px 32px; margin:12px;
      font-size:20px; font-weight:600; color:#fff; text-decoration:none; cursor:pointer;
      border:none; border-radius:12px;
      background:linear-gradient(135deg, var(--primary), var(--primary-600));
      box-shadow:0 10px 22px rgba(43,108,255,.3);
      transition: transform .06s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
  </style>
</head>
<body>
  <!-- –¢—É–º–±–ª–µ—Ä —Ç–µ–º—ã -->
  <button id="themeBtn" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì –¢–µ–º–∞</button>

  <div class="content-wrapper">
    <!-- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞–Ω–∏—è: —Å–∫—Ä—ã—Ç–∞ –¥–æ –∫–æ–Ω—Ü–∞ –æ—Ç—Å—á—ë—Ç–∞ -->
    <div class="task-container" id="instructionBox" style="display:none" aria-labelledby="taskTitle" aria-describedby="inst">
      <b id="taskTitle">Task 1. Imagine that you are preparing a project with your friend.</b>
      You have found some interesting material for the presentation and you want to read this text to your friend.
      You have 1.5 minutes to read the text silently, then be ready to read it out loud. You will not have more than 1.5 minutes to read it.
      <div class="instruction" id="inst">You will read the text aloud for not more than 1.5 minutes.</div>
    </div>

    <!-- –û—Ç—Å—á—ë—Ç -->
    <div id="timer" class="timer" aria-live="polite">3</div>

    <!-- –¢–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è: —Å–∫—Ä—ã—Ç –¥–æ –∫–æ–Ω—Ü–∞ –æ—Ç—Å—á—ë—Ç–∞ -->
    <div class="reading-box" id="textBox" style="display:none">Family life is not always peaceful, and conflicts are an inevitable part of human relationships. Arguments may arise from differences in opinions, responsibilities, or financial problems. For example, teenagers often complain about strict rules, while parents worry about academic performance and future careers. Such disagreements, if not handled carefully, can damage trust and emotional closeness.

However, psychologists emphasize that conflicts are not always destructive. On the contrary, they can help families learn negotiation skills and strengthen mutual understanding. The key is to remain respectful and avoid aggressive behavior. Family councils, open discussions, and even professional counseling are effective methods of conflict resolution.

In recent decades, researchers have discovered that children from families where conflicts are solved constructively usually demonstrate higher levels of tolerance and cooperation. Although quarrels may be painful, they are a unique chance for growth and emotional maturity.
    </div>


    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
    <div style="text-align:center; margin-bottom:30px;">
      <button class="btn" id="endBtn" type="button" aria-label="–ó–∞–∫–æ–Ω—á–∏—Ç—å –∑–∞–ø–∏—Å—å" style="display:none">‚úÖ –ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ü—Ä–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞–¥ —Ñ–∏–∫—Å-–±–∞—Ä–æ–º -->
  <div style="height: calc(var(--footer-h) + 24px);"></div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ -->
  <div id="progressContainerFixed" role="timer" aria-live="polite" aria-atomic="true"
       aria-label="–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞" style="display:none">
    <div id="progressBarFixed">
      <span id="progressTime" class="progress-time">01:30</span>
    </div>
  </div>

  <script type="module">
    import { toggleThemeInit, navigateOnce, fmtTime } from '../../../common.js';

    toggleThemeInit();

    const timerEl        = document.getElementById('timer');
    const instructionBox = document.getElementById('instructionBox');
    const textBox        = document.getElementById('textBox');
    const endBtn         = document.getElementById('endBtn');
    const progressWrap   = document.getElementById('progressContainerFixed');
    const progressBar    = document.getElementById('progressBarFixed');
    const progressTime   = document.getElementById('progressTime');

    const RESULT_URL = location.pathname.replace(/_3_task\.html$/i, '_4_result.html');

    const inExam      = (sessionStorage.getItem('exam_flow') === '1');
    const varFromSS   = sessionStorage.getItem('exam_variant') || '';
    const varFromURL  = (location.pathname.match(/variant(\d+)/i) || [,''])[1];
    const EXAM_VARIANT= varFromSS || varFromURL || '';
    const EXAM_NEXT_URL = `../../../exams_countdown.html?next=2&variant=${encodeURIComponent(EXAM_VARIANT)}`;

    /* === –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∑–∞–ø–∏—Å—å === */
    let mediaRecorder = null, audioChunks = [], streamRef = null;
    let chosenMime = '', hasStopped = false;

    function pickMimeType(){
      const candidates = [
        'audio/webm;codecs=opus','audio/webm','audio/mp4',
        'audio/ogg;codecs=opus','audio/ogg'
      ];
      for (const t of candidates){ if (window.MediaRecorder?.isTypeSupported?.(t)) return t; }
      return '';
    }

    async function initMic(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        streamRef = stream;

        chosenMime = pickMimeType();
        mediaRecorder = chosenMime ? new MediaRecorder(stream, { mimeType: chosenMime }) : new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e)=>{ if (e.data?.size) audioChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          if (hasStopped) return;
          hasStopped = true;
          try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
          const blobType = chosenMime || mediaRecorder.mimeType || 'audio/webm';
          const audioBlob = new Blob(audioChunks, { type: blobType });
          const reader = new FileReader();
          reader.onloadend = () => {
            try{
              sessionStorage.setItem('ege1_audio_base64', reader.result);
              sessionStorage.setItem('ege1_audio_mime', blobType);
            }catch{}
            navigateOnce(inExam ? EXAM_NEXT_URL : RESULT_URL);
          };
          reader.readAsDataURL(audioBlob);
        };

        startCountdown();
      }catch(err){
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (err?.message || err));
        startCountdown(); // –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π
      }
    }

    /* === –û—Ç—Å—á—ë—Ç 3-2-1 === */
    let countdown = 3;
    let cdInterval = 0;
    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function startCountdown(){
      timerEl.style.display = 'block';
      timerEl.textContent = countdown;
      cdInterval = setInterval(()=>{
        timerEl.style.color = (countdown > 1) ? '#2b6cff' : '#b30000';
        timerEl.textContent = countdown;
        if (!reduceMotion){
          timerEl.style.transform = 'scale(1.2)';
          setTimeout(()=>{ timerEl.style.transform = 'scale(1)'; }, 200);
        }
        countdown--;
        if (countdown < 0){
          clearInterval(cdInterval);
          startTask();
        }
      },1000);
    }

    /* === –¢–∞–π–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ 1:30 –Ω–∞ rAF === */
    const TOTAL_MS = 90_000;
    let endTs = 0, rafId = 0, lastAnnounce = 0;

    function startTask(){
      instructionBox.style.display = 'block';
      textBox.style.display        = 'block';
      endBtn.style.display         = 'inline-block';
      progressWrap.style.display   = 'block';
      timerEl.style.display        = 'none';

      audioChunks = [];
      try{ if (mediaRecorder && mediaRecorder.state !== 'recording') mediaRecorder.start(); }catch{}

      progressBar.classList.add('rAF');
      endTs = performance.now() + TOTAL_MS;
      progressTime.textContent = fmtTime(TOTAL_MS);
      progressBar.style.width  = '100%';

      tick();
      endBtn.onclick = ()=> safeStopOrFinish();
    }

    function tick(){
      const left = Math.max(0, endTs - performance.now());
      progressBar.style.width = `${(left / TOTAL_MS) * 100}%`;
      if (!lastAnnounce || performance.now() - lastAnnounce > 250){
        progressTime.textContent = fmtTime(left);
        lastAnnounce = performance.now();
      }
      if (left <= 0){ safeStopOrFinish(); }
      else { rafId = requestAnimationFrame(tick); }
    }

    function safeStopOrFinish(){
      try{ cancelAnimationFrame(rafId); }catch{}
      if (hasStopped){ navigateOnce(inExam ? EXAM_NEXT_URL : RESULT_URL); return; }
      try{
        if (mediaRecorder?.state === 'recording'){ mediaRecorder.stop(); }
        else {
          try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
          navigateOnce(inExam ? EXAM_NEXT_URL : RESULT_URL);
        }
      }catch{
        try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
        navigateOnce(inExam ? EXAM_NEXT_URL : RESULT_URL);
      }
    }

    window.addEventListener('beforeunload', ()=>{
      try{ cancelAnimationFrame(rafId); }catch{}
      try{ if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); }catch{}
      try{ streamRef?.getTracks()?.forEach(t=>t.stop()); }catch{}
    });

    /* === BFCache: –≤–æ–∑–≤—Ä–∞—Ç —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ ‚Üí —Ä–µ—Å—Ç–∞—Ä—Ç === */
    function isBackForwardNav(){
      try{
        const nav = performance.getEntriesByType('navigation')[0];
        return nav && nav.type === 'back_forward';
      }catch{ return false; }
    }
    function resetAndRestart(){
      try { cancelAnimationFrame(rafId); } catch {}
      try { clearInterval(cdInterval); } catch {}
      try { if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); } catch {}
      try { streamRef?.getTracks()?.forEach(t=>t.stop()); } catch {}

      timerEl.style.display        = 'block';
      timerEl.textContent          = '3';
      instructionBox.style.display = 'none';
      textBox.style.display        = 'none';
      endBtn.style.display         = 'none';
      progressWrap.style.display   = 'none';
      progressBar.style.width      = '100%';
      progressTime.textContent     = fmtTime(TOTAL_MS);

      audioChunks = [];
      hasStopped  = false;
      countdown   = 3;

      initMic();
    }
    window.addEventListener('pageshow', (e)=>{
      try { navigateOnce.lock = false; } catch {}
      if (e.persisted || isBackForwardNav()) resetAndRestart();
    });

    window.onload = initMic;
  </script>
</body>
</html>